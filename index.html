<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Kelimeli Mahjong</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; overflow: hidden; height: 100vh; touch-action: manipulation; }
    .game-container { display: flex; flex-direction: column; height: 100vh; max-width: 100%; margin: 0 auto; }
    .header { background: rgba(0, 0, 0, 0.3); padding: 12px 16px; backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; position: relative; z-index: 100; }
    .stat-item { display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .stat-label { font-size: 10px; opacity: 0.8; text-transform: uppercase; }
    .stat-value { font-size: 18px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .combo-indicator { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 14px; box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4); animation: comboPopIn 0.3s ease; display: none; pointer-events: none; }
    .combo-indicator.active { display: block; }
    @keyframes comboPopIn { from { transform: translateX(-50%) scale(0.5); opacity: 0; } to { transform: translateX(-50%) scale(1); opacity: 1; } }
    .game-board { flex: 1; display: flex; align-items: center; justify-content: center; padding: 16px; position: relative; overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
    .game-board::-webkit-scrollbar { height: 4px; }
    .game-board::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 2px; }
    .board { position: relative; margin: 0 auto; min-width: min-content; }
    .tile { position: absolute; background: linear-gradient(145deg, #ffffff, #f0f0f0); border: 3px solid #ddd; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #2d3748; cursor: pointer; user-select: none; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 8px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8); text-align: center; line-height: 1.1; padding: 6px; word-break: break-word; overflow: hidden; text-overflow: ellipsis; hyphens: auto; }
    .tile.playable { border-color: #48bb78; box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.3), 0 0 20px rgba(72, 187, 120, 0.6), 0 4px 8px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8); animation: playablePulse 2s ease-in-out infinite; }
    @keyframes playablePulse { 0%, 100% { box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.3), 0 0 20px rgba(72, 187, 120, 0.6), 0 4px 8px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8); } 50% { box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.5), 0 0 30px rgba(72, 187, 120, 0.9), 0 4px 12px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.8); } }
    .tile.blocked { opacity: 0.3; filter: grayscale(0.8); cursor: not-allowed; box-shadow: 0 2px 4px rgba(0,0,0,0.1); animation: none; }
    .tile.selected { background: linear-gradient(145deg, #bee3f8, #90cdf4); border-color: #3182ce; border-width: 4px; transform: translateY(-8px) scale(1.05); box-shadow: 0 12px 24px rgba(49, 130, 206, 0.5), inset 0 2px 0 rgba(255,255,255,0.9); z-index: 1000 !important; }
    .tile.matched { animation: matchSuccess 0.6s ease forwards; pointer-events: none; }
    @keyframes matchSuccess { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2) rotate(5deg); background: linear-gradient(145deg, #c6f6d5, #9ae6b4); border-color: #38a169; } 100% { transform: scale(0); opacity: 0; } }
    .tile.wrong { animation: wrongShake 0.5s ease; }
    @keyframes wrongShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
    .tile.hint { animation: hintGlow 1s ease-in-out 3; }
    @keyframes hintGlow { 0%, 100% { border-color: #f6ad55; box-shadow: 0 0 20px rgba(246, 173, 85, 0.8); } 50% { border-color: #ed8936; box-shadow: 0 0 40px rgba(237, 137, 54, 1); } }
    .controls { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(10px); padding: 12px 16px; flex-shrink: 0; position: relative; z-index: 100; }
    .control-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .control-row:last-child { margin-bottom: 0; }
    select, button { flex: 1; padding: 12px 8px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; touch-action: manipulation; }
    select { background: rgba(255, 255, 255, 0.2); color: #fff; text-align: center; -webkit-appearance: none; appearance: none; }
    select:disabled { opacity: 0.5; cursor: not-allowed; }
    button { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
    button:active { transform: scale(0.96); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.hint-btn { background: linear-gradient(135deg, #f6ad55, #ed8936); }
    button.reset-btn { background: linear-gradient(135deg, #fc8181, #e53e3e); }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px; }
    .modal.hidden { display: none; }
    .modal-content { background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 24px; padding: 32px 24px; max-width: 400px; width: 100%; text-align: center; animation: modalSlideIn 0.3s ease; }
    @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .modal h2 { font-size: 32px; margin-bottom: 16px; }
    .modal p { font-size: 16px; margin-bottom: 20px; opacity: 0.9; }
    .modal input { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 18px; text-align: center; font-weight: 600; margin-bottom: 16px; background: rgba(255, 255, 255, 0.9); color: #2d3748; }
    .modal button { width: 100%; background: rgba(255, 255, 255, 0.2); border: 2px solid #fff; padding: 16px; font-size: 18px; }
    .notification { position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-100px); background: linear-gradient(135deg, #48bb78, #38a169); padding: 12px 20px; border-radius: 12px; font-weight: 700; font-size: 14px; box-shadow: 0 8px 24px rgba(72, 187, 120, 0.4); z-index: 9999; opacity: 0; transition: all 0.3s ease; pointer-events: none; }
    .notification.show { transform: translateX(-50%) translateY(0); opacity: 1; }
  </style>
</head>
<body>
  <div class="modal hidden" id="nameModal">
    <div class="modal-content">
      <h2>üÄÑ Ho≈ü Geldin!</h2>
      <p>Adƒ±nƒ± gir ve ba≈ülayalƒ±m</p>
      <input type="text" id="nameInput" placeholder="ƒ∞smin..." maxlength="20" />
      <button id="nameSubmit">Ba≈üla üöÄ</button>
    </div>
  </div>

  <div class="modal hidden" id="winModal">
    <div class="modal-content">
      <h2>üéâ Kazandƒ±n!</h2>
      <p id="winMessage"></p>
      <button id="playAgain">Tekrar Oyna</button>
    </div>
  </div>

  <div class="notification" id="notification"></div>

  <div class="game-container">
    <div class="header">
      <div class="stat-item">
        <div class="stat-label">Puan</div>
        <div class="stat-value" id="score">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">S√ºre</div>
        <div class="stat-value" id="timer">0:00</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Kalan</div>
        <div class="stat-value" id="remaining">0</div>
      </div>
    </div>

    <div class="combo-indicator" id="comboIndicator">üî• Combo x0</div>

    <div class="game-board" id="gameBoard">
      <div class="board" id="board"></div>
    </div>

    <div class="controls">
      <div class="control-row">
        <select id="langSelect">
          <option value="en">üá¨üáß EN</option>
          <option value="es">üá™üá∏ ES</option>
          <option value="kr">üá∞üá∑ KR</option>
        </select>
        <select id="levelSelect">
          <option value="a1">A1</option>
          <option value="a2">A2</option>
          <option value="b1">B1</option>
        </select>
        <select id="difficultySelect">
          <option value="easy">üü¢ Kolay</option>
          <option value="medium">üü° Orta</option>
          <option value="hard">üî¥ Zor</option>
        </select>
      </div>
      <div class="control-row">
        <button id="startBtn">‚ñ∂Ô∏è Ba≈ülat</button>
        <button class="hint-btn" id="hintBtn" disabled>üí°</button>
        <button class="reset-btn" id="resetBtn" disabled>üîÑ</button>
      </div>
    </div>
  </div>

  <script>
    // ===== GAME STATE MACHINE =====
    const STATES = { IDLE: 'idle', PLAYING: 'playing', PAUSED: 'paused', FINISHED: 'finished' };
    
    const gameState = {
      current: STATES.IDLE,
      lang: 'en',
      level: 'a1',
      difficulty: 'easy',
      score: 0,
      moves: 0,
      matches: 0,
      combo: 0,
      timeElapsed: 0,
      freeHints: 2,
      totalPairs: 0,
      tiles: [],
      selectedTile: null,
      timer: null
    };

    // ===== WORD PAIRS =====
    const words = {
      en: {
        a1: [['hello','merhaba'],['yes','evet'],['no','hayƒ±r'],['water','su'],['dog','k√∂pek'],['cat','kedi'],['house','ev'],['book','kitap'],['sun','g√ºne≈ü'],['day','g√ºn'],['night','gece'],['family','aile'],['car','araba'],['tree','aƒüa√ß'],['food','yemek'],['milk','s√ºt'],['tea','√ßay'],['hot','sƒ±cak'],['cold','soƒüuk'],['big','b√ºy√ºk'],['small','k√º√ß√ºk'],['good','iyi'],['bad','k√∂t√º'],['red','kƒ±rmƒ±zƒ±'],['blue','mavi']],
        a2: [['school','okul'],['work','i≈ü'],['money','para'],['city','≈üehir'],['road','yol'],['train','tren'],['plane','u√ßak'],['rain','yaƒümur'],['snow','kar'],['wind','r√ºzgar'],['summer','yaz'],['winter','kƒ±≈ü'],['week','hafta'],['month','ay'],['year','yƒ±l'],['time','zaman'],['hour','saat'],['today','bug√ºn'],['music','m√ºzik'],['song','≈üarkƒ±'],['game','oyun'],['sport','spor'],['price','fiyat'],['cheap','ucuz'],['buy','almak']],
        b1: [['travel','seyahat'],['culture','k√ºlt√ºr'],['language','dil'],['government','h√ºk√ºmet'],['law','yasa'],['freedom','√∂zg√ºrl√ºk'],['society','toplum'],['economy','ekonomi'],['business','i≈ü'],['company','≈üirket'],['career','kariyer'],['education','eƒüitim'],['science','bilim'],['research','ara≈ütƒ±rma'],['technology','teknoloji'],['health','saƒülƒ±k'],['medicine','ila√ß'],['doctor','doktor'],['patient','hasta'],['environment','√ßevre'],['nature','doƒüa'],['pollution','kirlilik'],['energy','enerji'],['climate','iklim'],['ocean','okyanus']]
      },
      es: {
        a1: [['hola','merhaba'],['s√≠','evet'],['no','hayƒ±r'],['agua','su'],['perro','k√∂pek'],['gato','kedi'],['casa','ev'],['libro','kitap'],['sol','g√ºne≈ü'],['d√≠a','g√ºn'],['noche','gece'],['familia','aile'],['coche','araba'],['√°rbol','aƒüa√ß'],['comida','yemek'],['leche','s√ºt'],['t√©','√ßay'],['caliente','sƒ±cak'],['fr√≠o','soƒüuk'],['grande','b√ºy√ºk'],['peque√±o','k√º√ß√ºk'],['bueno','iyi'],['malo','k√∂t√º'],['rojo','kƒ±rmƒ±zƒ±'],['azul','mavi']],
        a2: [['escuela','okul'],['trabajo','i≈ü'],['dinero','para'],['ciudad','≈üehir'],['camino','yol'],['tren','tren'],['avi√≥n','u√ßak'],['lluvia','yaƒümur'],['nieve','kar'],['viento','r√ºzgar'],['verano','yaz'],['invierno','kƒ±≈ü'],['semana','hafta'],['mes','ay'],['a√±o','yƒ±l'],['tiempo','zaman'],['hora','saat'],['hoy','bug√ºn'],['m√∫sica','m√ºzik'],['canci√≥n','≈üarkƒ±'],['juego','oyun'],['deporte','spor'],['precio','fiyat'],['barato','ucuz'],['comprar','almak']],
        b1: [['viaje','seyahat'],['cultura','k√ºlt√ºr'],['idioma','dil'],['gobierno','h√ºk√ºmet'],['ley','yasa'],['libertad','√∂zg√ºrl√ºk'],['sociedad','toplum'],['econom√≠a','ekonomi'],['negocio','i≈ü'],['empresa','≈üirket'],['carrera','kariyer'],['educaci√≥n','eƒüitim'],['ciencia','bilim'],['investigaci√≥n','ara≈ütƒ±rma'],['tecnolog√≠a','teknoloji'],['salud','saƒülƒ±k'],['medicina','ila√ß'],['m√©dico','doktor'],['paciente','hasta'],['ambiente','√ßevre'],['naturaleza','doƒüa'],['contaminaci√≥n','kirlilik'],['energ√≠a','enerji'],['clima','iklim'],['oc√©ano','okyanus']]
      },
      kr: {
        a1: [['ÏïàÎÖï','merhaba'],['ÎÑ§','evet'],['ÏïÑÎãàÏò§','hayƒ±r'],['Î¨º','su'],['Í∞ú','k√∂pek'],['Í≥†ÏñëÏù¥','kedi'],['Ïßë','ev'],['Ï±Ö','kitap'],['Ìï¥','g√ºne≈ü'],['ÎÇÆ','g√ºn'],['Î∞§','gece'],['Í∞ÄÏ°±','aile'],['Ï∞®','araba'],['ÎÇòÎ¨¥','aƒüa√ß'],['ÏùåÏãù','yemek'],['Ïö∞Ïú†','s√ºt'],['Ï∞®','√ßay'],['Îú®Í±∞Ïö¥','sƒ±cak'],['Ï∞®Í∞ÄÏö¥','soƒüuk'],['ÌÅ∞','b√ºy√ºk'],['ÏûëÏùÄ','k√º√ß√ºk'],['Ï¢ãÏùÄ','iyi'],['ÎÇòÏÅú','k√∂t√º'],['Îπ®Í∞Ñ','kƒ±rmƒ±zƒ±'],['ÌååÎûÄ','mavi']],
        a2: [['ÌïôÍµê','okul'],['Ïùº','i≈ü'],['Îèà','para'],['ÎèÑÏãú','≈üehir'],['Í∏∏','yol'],['Í∏∞Ï∞®','tren'],['ÎπÑÌñâÍ∏∞','u√ßak'],['ÎπÑ','yaƒümur'],['Îàà','kar'],['Î∞îÎûå','r√ºzgar'],['Ïó¨Î¶Ñ','yaz'],['Í≤®Ïö∏','kƒ±≈ü'],['Ï£º','hafta'],['Ïõî','ay'],['ÎÖÑ','yƒ±l'],['ÏãúÍ∞Ñ','zaman'],['Ïãú','saat'],['Ïò§Îäò','bug√ºn'],['ÏùåÏïÖ','m√ºzik'],['ÎÖ∏Îûò','≈üarkƒ±'],['Í≤åÏûÑ','oyun'],['Ïä§Ìè¨Ï∏†','spor'],['Í∞ÄÍ≤©','fiyat'],['Ïãº','ucuz'],['ÏÇ¨Îã§','almak']],
        b1: [['Ïó¨Ìñâ','seyahat'],['Î¨∏Ìôî','k√ºlt√ºr'],['Ïñ∏Ïñ¥','dil'],['Ï†ïÎ∂Ä','h√ºk√ºmet'],['Î≤ï','yasa'],['ÏûêÏú†','√∂zg√ºrl√ºk'],['ÏÇ¨Ìöå','toplum'],['Í≤ΩÏ†ú','ekonomi'],['ÏÇ¨ÏóÖ','i≈ü'],['ÌöåÏÇ¨','≈üirket'],['Í≤ΩÎ†•','kariyer'],['ÍµêÏú°','eƒüitim'],['Í≥ºÌïô','bilim'],['Ïó∞Íµ¨','ara≈ütƒ±rma'],['Í∏∞Ïà†','teknoloji'],['Í±¥Í∞ï','saƒülƒ±k'],['ÏïΩ','ila√ß'],['ÏùòÏÇ¨','doktor'],['ÌôòÏûê','hasta'],['ÌôòÍ≤Ω','√ßevre'],['ÏûêÏó∞','doƒüa'],['Ïò§Ïóº','kirlilik'],['ÏóêÎÑàÏßÄ','enerji'],['Í∏∞ÌõÑ','iklim'],['ÎåÄÏñë','okyanus']]
      }
    };

    // ===== LAYOUTS =====
    const layouts = {
      easy: { tiles:24, grid:{cols:6,rows:4}, pos:[{x:1,y:0,z:0},{x:2,y:0,z:0},{x:3,y:0,z:0},{x:4,y:0,z:0},{x:0,y:1,z:0},{x:1,y:1,z:0},{x:2,y:1,z:0},{x:3,y:1,z:0},{x:4,y:1,z:0},{x:5,y:1,z:0},{x:0,y:2,z:0},{x:1,y:2,z:0},{x:2,y:2,z:0},{x:3,y:2,z:0},{x:4,y:2,z:0},{x:5,y:2,z:0},{x:1,y:3,z:0},{x:2,y:3,z:0},{x:3,y:3,z:0},{x:4,y:3,z:0},{x:2,y:1,z:1},{x:3,y:1,z:1},{x:2,y:2,z:1},{x:3,y:2,z:1}] },
      medium: { tiles:48, grid:{cols:8,rows:6}, pos:[{x:1,y:0,z:0},{x:2,y:0,z:0},{x:3,y:0,z:0},{x:4,y:0,z:0},{x:5,y:0,z:0},{x:6,y:0,z:0},{x:0,y:1,z:0},{x:1,y:1,z:0},{x:2,y:1,z:0},{x:3,y:1,z:0},{x:4,y:1,z:0},{x:5,y:1,z:0},{x:6,y:1,z:0},{x:7,y:1,z:0},{x:0,y:2,z:0},{x:1,y:2,z:0},{x:2,y:2,z:0},{x:3,y:2,z:0},{x:4,y:2,z:0},{x:5,y:2,z:0},{x:6,y:2,z:0},{x:7,y:2,z:0},{x:0,y:3,z:0},{x:1,y:3,z:0},{x:2,y:3,z:0},{x:3,y:3,z:0},{x:4,y:3,z:0},{x:5,y:3,z:0},{x:6,y:3,z:0},{x:7,y:3,z:0},{x:0,y:4,z:0},{x:1,y:4,z:0},{x:2,y:4,z:0},{x:3,y:4,z:0},{x:4,y:4,z:0},{x:5,y:4,z:0},{x:6,y:4,z:0},{x:7,y:4,z:0},{x:1,y:5,z:0},{x:2,y:5,z:0},{x:3,y:5,z:0},{x:4,y:5,z:0},{x:5,y:5,z:0},{x:6,y:5,z:0},{x:2,y:2,z:1},{x:3,y:2,z:1},{x:4,y:2,z:1},{x:5,y:2,z:1},{x:2,y:3,z:1},{x:3,y:3,z:1},{x:4,y:3,z:1},{x:5,y:3,z:1}] },
      hard: { tiles:72, grid:{cols:9,rows:8}, pos:[{x:1,y:0,z:0},{x:2,y:0,z:0},{x:3,y:0,z:0},{x:4,y:0,z:0},{x:5,y:0,z:0},{x:6,y:0,z:0},{x:7,y:0,z:0},{x:0,y:1,z:0},{x:1,y:1,z:0},{x:2,y:1,z:0},{x:3,y:1,z:0},{x:4,y:1,z:0},{x:5,y:1,z:0},{x:6,y:1,z:0},{x:7,y:1,z:0},{x:8,y:1,z:0},{x:0,y:2,z:0},{x:1,y:2,z:0},{x:2,y:2,z:0},{x:3,y:2,z:0},{x:4,y:2,z:0},{x:5,y:2,z:0},{x:6,y:2,z:0},{x:7,y:2,z:0},{x:8,y:2,z:0},{x:0,y:3,z:0},{x:1,y:3,z:0},{x:2,y:3,z:0},{x:3,y:3,z:0},{x:4,y:3,z:0},{x:5,y:3,z:0},{x:6,y:3,z:0},{x:7,y:3,z:0},{x:8,y:3,z:0},{x:0,y:4,z:0},{x:1,y:4,z:0},{x:2,y:4,z:0},{x:3,y:4,z:0},{x:4,y:4,z:0},{x:5,y:4,z:0},{x:6,y:4,z:0},{x:7,y:4,z:0},{x:8,y:4,z:0},{x:0,y:5,z:0},{x:1,y:5,z:0},{x:2,y:5,z:0},{x:3,y:5,z:0},{x:4,y:5,z:0},{x:5,y:5,z:0},{x:6,y:5,z:0},{x:7,y:5,z:0},{x:8,y:5,z:0},{x:0,y:6,z:0},{x:1,y:6,z:0},{x:2,y:6,z:0},{x:3,y:6,z:0},{x:4,y:6,z:0},{x:5,y:6,z:0},{x:6,y:6,z:0},{x:7,y:6,z:0},{x:8,y:6,z:0},{x:1,y:7,z:0},{x:2,y:7,z:0},{x:3,y:7,z:0},{x:4,y:7,z:0},{x:5,y:7,z:0},{x:6,y:7,z:0},{x:7,y:7,z:0},{x:3,y:3,z:1},{x:4,y:3,z:1},{x:5,y:3,z:1},{x:3,y:4,z:1},{x:4,y:4,z:1},{x:5,y:4,z:1}] }
    };

    // ===== DOM =====
    const $ = id => document.getElementById(id);
    const board = $('board'), scoreEl = $('score'), timerEl = $('timer'), remainingEl = $('remaining');
    const comboIndicator = $('comboIndicator'), startBtn = $('startBtn'), hintBtn = $('hintBtn'), resetBtn = $('resetBtn');
    const langSelect = $('langSelect'), levelSelect = $('levelSelect'), difficultySelect = $('difficultySelect');
    const nameModal = $('nameModal'), nameInput = $('nameInput'), nameSubmit = $('nameSubmit');
    const winModal = $('winModal'), winMessage = $('winMessage'), playAgain = $('playAgain');
    const notification = $('notification');

    // ===== STATE MANAGEMENT =====
    function transitionTo(state) {
      console.log(`State: ${gameState.current} -> ${state}`);
      gameState.current = state;
      updateUI();
    }

    function updateUI() {
      const s = gameState.current;
      startBtn.disabled = (s === STATES.PLAYING);
      resetBtn.disabled = (s === STATES.IDLE);
      hintBtn.disabled = (s !== STATES.PLAYING);
      
      const locked = (s === STATES.PLAYING || s === STATES.PAUSED);
      langSelect.disabled = locked;
      levelSelect.disabled = locked;
      difficultySelect.disabled = locked;
      
      startBtn.textContent = s === STATES.PLAYING ? '‚è∏Ô∏è Duraklat' : s === STATES.PAUSED ? '‚ñ∂Ô∏è Devam' : '‚ñ∂Ô∏è Ba≈ülat';
      
      scoreEl.textContent = gameState.score;
      timerEl.textContent = formatTime(gameState.timeElapsed);
      remainingEl.textContent = gameState.totalPairs - gameState.matches;
    }

    function resetGame() {
      if (gameState.timer) clearInterval(gameState.timer);
      gameState.score = 0;
      gameState.moves = 0;
      gameState.matches = 0;
      gameState.combo = 0;
      gameState.timeElapsed = 0;
      gameState.freeHints = 2;
      gameState.tiles = [];
      gameState.selectedTile = null;
      gameState.timer = null;
      board.innerHTML = '';
      comboIndicator.classList.remove('active');
      updateUI();
    }

    function forceEnd(reason) {
      if (gameState.timer) clearInterval(gameState.timer);
      resetGame();
      transitionTo(STATES.IDLE);
      if (reason) showNotif(`üîÑ ${reason}`, 2000);
    }

    // ===== SETTINGS HANDLERS =====
    langSelect.addEventListener('change', () => {
      if (gameState.lang === langSelect.value) return;
      if (gameState.current !== STATES.IDLE) forceEnd('Dil deƒüi≈ütirildi');
      gameState.lang = langSelect.value;
      setupBoard();
      showNotif(`üìö ${{'en':'ƒ∞ngilizce','es':'ƒ∞spanyolca','kr':'Korece'}[gameState.lang]}`, 1500);
    });

    levelSelect.addEventListener('change', () => {
      if (gameState.level === levelSelect.value) return;
      if (gameState.current !== STATES.IDLE) forceEnd('Seviye deƒüi≈ütirildi');
      gameState.level = levelSelect.value;
      setupBoard();
      showNotif(`üìä Seviye: ${gameState.level.toUpperCase()}`, 1500);
    });

    difficultySelect.addEventListener('change', () => {
      if (gameState.difficulty === difficultySelect.value) return;
      if (gameState.current !== STATES.IDLE) forceEnd('Zorluk deƒüi≈ütirildi');
      gameState.difficulty = difficultySelect.value;
      setupBoard();
      showNotif(`üéÆ ${{'easy':'Kolay','medium':'Orta','hard':'Zor'}[gameState.difficulty]}`, 1500);
    });

    // ===== HELPERS =====
    function shuffle(arr) { for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
    function formatTime(s) { const m=Math.floor(s/60),sec=s%60; return `${m}:${sec.toString().padStart(2,'0')}`; }
    function showNotif(msg, dur=2000) { notification.textContent=msg; notification.classList.add('show'); setTimeout(()=>notification.classList.remove('show'),dur); }

    // ===== TILE LOGIC =====
    function isBlocked(tile) {
      const above = gameState.tiles.find(t=>!t.matched&&t.z===tile.z+1&&Math.abs(t.x-tile.x)<=0.5&&Math.abs(t.y-tile.y)<=0.5);
      if(above) return true;
      const left = gameState.tiles.some(t=>!t.matched&&t.z===tile.z&&t.x===tile.x-1&&t.y===tile.y);
      const right = gameState.tiles.some(t=>!t.matched&&t.z===tile.z&&t.x===tile.x+1&&t.y===tile.y);
      return left&&right;
    }

    function updateTiles() {
      gameState.tiles.forEach(t=>{
        if(!t.matched){
          const blocked=isBlocked(t);
          t.element.classList.toggle('blocked',blocked);
          t.element.classList.toggle('playable',!blocked);
        }
      });
    }

    // ===== SETUP BOARD =====
    function setupBoard() {
      board.innerHTML = '';
      gameState.tiles = [];
      
      const layout = layouts[gameState.difficulty];
      gameState.totalPairs = layout.tiles/2;
      
      const w=window.innerWidth, h=window.innerHeight;
      const availW=w-32, availH=h-272;
      const {cols,rows}=layout.grid;
      let tw=Math.floor(availW/cols), th=Math.floor(availH/rows);
      if(th>tw*1.25) th=Math.floor(tw*1.25); else tw=Math.floor(th*0.8);
      if(tw<48||th<60){showNotif('‚ö†Ô∏è Ekran √ßok k√º√ß√ºk, kolay mod dene',3000);return;}
      
      const pairs=shuffle([...words[gameState.lang][gameState.level]]).slice(0,gameState.totalPairs);
      const tileWords=[];
      pairs.forEach(([f,t])=>{tileWords.push({word:f,pairId:f});tileWords.push({word:t,pairId:f});});
      shuffle(tileWords);
      
      layout.pos.forEach((pos,idx)=>{
        const data=tileWords[idx];
        const tile={x:pos.x,y:pos.y,z:pos.z,word:data.word,pairId:data.pairId,matched:false,element:null};
        const div=document.createElement('div');
        div.className='tile';
        div.textContent=tile.word;
        div.style.width=tw+'px';
        div.style.height=th+'px';
        div.style.fontSize=Math.max(11,Math.floor(tw*0.22))+'px';
        div.style.left=(pos.x*(tw+8)-pos.z*4)+'px';
        div.style.top=(pos.y*(th+8)-pos.z*4)+'px';
        div.style.zIndex=pos.z*100+pos.y*10+pos.x;
        div.addEventListener('click',()=>onTileClick(tile));
        tile.element=div;
        gameState.tiles.push(tile);
        board.appendChild(div);
      });
      
      const maxX=Math.max(...layout.pos.map(p=>p.x));
      const maxY=Math.max(...layout.pos.map(p=>p.y));
      board.style.width=(maxX*(tw+8)+tw)+'px';
      board.style.height=(maxY*(th+8)+th)+'px';
      
      updateTiles();
      updateUI();
    }

    // ===== TILE CLICK =====
    function onTileClick(tile) {
      if(gameState.current!==STATES.PLAYING||tile.matched||isBlocked(tile)) return;
      
      if(gameState.selectedTile===tile){
        tile.element.classList.remove('selected');
        gameState.selectedTile=null;
        return;
      }
      
      if(!gameState.selectedTile){
        gameState.selectedTile=tile;
        tile.element.classList.add('selected');
      }else{
        gameState.moves++;
        if(gameState.selectedTile.pairId===tile.pairId&&gameState.selectedTile.word!==tile.word){
          gameState.selectedTile.matched=true;
          tile.matched=true;
          gameState.selectedTile.element.classList.remove('selected','playable');
          gameState.selectedTile.element.classList.add('matched');
          tile.element.classList.add('matched');
          gameState.matches++;
          gameState.combo++;
          const mult=gameState.combo>=3?1.5:1;
          const pts=Math.floor(100*mult);
          gameState.score+=pts;
          if(gameState.combo>=3){
            comboIndicator.textContent=`üî• Combo x${gameState.combo}`;
            comboIndicator.classList.add('active');
            setTimeout(()=>comboIndicator.classList.remove('active'),2000);
          }
          showNotif(`+${pts} puan!`,1000);
          setTimeout(()=>{
            gameState.selectedTile.element.style.display='none';
            tile.element.style.display='none';
            gameState.selectedTile=null;
            updateTiles();
            updateUI();
            if(gameState.matches===gameState.totalPairs) endGame(true);
          },600);
        }else{
          gameState.combo=0;
          tile.element.classList.add('selected','wrong');
          gameState.selectedTile.element.classList.add('wrong');
          gameState.score=Math.max(0,gameState.score-10);
          showNotif('‚ùå Yanlƒ±≈ü!',800);
          setTimeout(()=>{
            gameState.selectedTile.element.classList.remove('selected','wrong');
            tile.element.classList.remove('selected','wrong');
            gameState.selectedTile=null;
            updateUI();
          },500);
        }
      }
    }

    // ===== GAME CONTROL =====
    startBtn.addEventListener('click',()=>{
      if(gameState.current===STATES.IDLE){
        resetGame();
        setupBoard();
        transitionTo(STATES.PLAYING);
        gameState.timer=setInterval(()=>{if(gameState.current===STATES.PLAYING){gameState.timeElapsed++;updateUI();}},1000);
        winModal.classList.add('hidden');
      }else if(gameState.current===STATES.PLAYING){
        transitionTo(STATES.PAUSED);
      }else if(gameState.current===STATES.PAUSED){
        transitionTo(STATES.PLAYING);
      }
    });

    resetBtn.addEventListener('click',()=>{
      if(gameState.current!==STATES.IDLE){
        forceEnd('Oyun sƒ±fƒ±rlandƒ±');
        setupBoard();
      }
    });

    hintBtn.addEventListener('click',()=>{
      if(gameState.current!==STATES.PLAYING) return;
      const avail=gameState.tiles.filter(t=>!t.matched&&!isBlocked(t));
      const pairs=[];
      for(let i=0;i<avail.length;i++){
        for(let j=i+1;j<avail.length;j++){
          if(avail[i].pairId===avail[j].pairId&&avail[i].word!==avail[j].word){
            pairs.push([avail[i],avail[j]]);
          }
        }
      }
      if(pairs.length>0){
        const [t1,t2]=pairs[0];
        t1.element.classList.add('hint');
        t2.element.classList.add('hint');
        setTimeout(()=>{t1.element.classList.remove('hint');t2.element.classList.remove('hint');},3000);
        if(gameState.freeHints>0){
          gameState.freeHints--;
          showNotif(`üí° Bedava! (${gameState.freeHints} kaldƒ±)`,1500);
        }else{
          gameState.score=Math.max(0,gameState.score-30);
          showNotif('üí° ƒ∞pucu (-30)',1500);
        }
        updateUI();
      }else{
        showNotif('‚ùå E≈üle≈üme yok!',1500);
      }
    });

    function endGame(won) {
      transitionTo(STATES.FINISHED);
      if(gameState.timer) clearInterval(gameState.timer);
      if(won){
        const bonus=Math.max(0,300-gameState.timeElapsed)*2;
        const final=gameState.score+bonus;
        winMessage.innerHTML=`<div style="font-size:18px;margin:16px 0;line-height:1.8">üéâ Puan: <strong>${final}</strong><br>‚è±Ô∏è ${formatTime(gameState.timeElapsed)}<br>‚ö° Bonus: +${bonus}<br>üë£ ${gameState.moves} hamle</div>`;
        winModal.classList.remove('hidden');
      }
    }

    playAgain.addEventListener('click',()=>{
      resetGame();
      transitionTo(STATES.IDLE);
      winModal.classList.add('hidden');
      setupBoard();
    });

    // ===== NAME =====
    let playerName=localStorage.getItem('mahjong_name');
    if(!playerName){nameModal.classList.remove('hidden');nameInput.focus();}
    nameSubmit.addEventListener('click',()=>{
      const n=nameInput.value.trim();
      if(n){playerName=n;localStorage.setItem('mahjong_name',n);nameModal.classList.add('hidden');}
    });
    nameInput.addEventListener('keypress',e=>{if(e.key==='Enter')nameSubmit.click();});

    // ===== INIT =====
    setupBoard();
    transitionTo(STATES.IDLE);
  </script>
</body>
</html>